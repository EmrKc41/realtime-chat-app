<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CanlÄ± Sohbet</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
    }
    header {
      background-color: #007bff;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #messages {
      padding: 20px;
      height: 300px;
      overflow-y: auto;
      background: white;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 60%;
      clear: both;
    }
    .me {
      background-color: #d4edda;
      float: right;
      text-align: right;
    }
    .other {
      background-color: #e2e3e5;
      float: left;
      text-align: left;
    }
    #form {
      display: flex;
      padding: 10px;
      background-color: #f1f1f1;
    }
    #form input {
      flex: 1;
      padding: 10px;
    }
    #form button {
      padding: 10px 20px;
    }
    #videos {
      display: flex;
      justify-content: center;
      padding: 10px;
      background-color: #f1f1f1;
    }
    video {
      width: 300px;
      height: 225px;
      margin: 0 10px;
      background: black;
    }
    #incomingCallModal {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px gray;
      display: none;
      z-index: 1000;
    }
    #incomingCallModal button {
      margin: 10px;
    }
  </style>
</head>
<body>

  <header>
    <div id="chatTitle">Sohbet: </div>
    <button id="callBtn">ðŸ“ž Ara</button>
  </header>

  <div id="messages"></div>

  <div id="form">
    <input type="text" id="messageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
    <button id="sendBtn">GÃ¶nder</button>
  </div>

  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div id="incomingCallModal">
    <p>ðŸ“ž Gelen Ã§aÄŸrÄ±!</p>
    <button id="acceptCallBtn">Kabul Et</button>
    <button id="declineCallBtn">Reddet</button>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();

    let localStream;
    let peerConnection;
    let remoteSocketId = null;
    const config = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    const username = prompt("AdÄ±nÄ±zÄ± girin:");
    document.getElementById("chatTitle").textContent = `Sohbet: ${username}`;

    socket.emit("newUser", username);

    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const messages = document.getElementById("messages");
    const callBtn = document.getElementById("callBtn");
    const incomingModal = document.getElementById("incomingCallModal");
    const acceptCallBtn = document.getElementById("acceptCallBtn");
    const declineCallBtn = document.getElementById("declineCallBtn");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    sendBtn.onclick = () => {
      const msg = messageInput.value.trim();
      if (!msg) return;
      socket.emit("sendMessage", { username, message: msg });
      appendMessage(username + ": " + msg, true);
      messageInput.value = "";
    };

    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    socket.on("receiveMessage", (data) => {
      appendMessage(`${data.username}: ${data.message}`, false);
    });

    function appendMessage(text, isMe) {
      const div = document.createElement("div");
      div.className = "message " + (isMe ? "me" : "other");
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // ðŸ“ž Arama baÅŸlatma
    callBtn.onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("callUser", {
            target: remoteSocketId,
            caller: socket.id,
            candidate: e.candidate
          });
        }
      };

      peerConnection.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      socket.emit("callUser", {
        target: remoteSocketId,
        caller: socket.id,
        offer
      });
    };

    // ðŸŽ¯ Gelen Ã§aÄŸrÄ±
    socket.on("incomingCall", async ({ from, offer }) => {
      remoteSocketId = from;
      incomingModal.style.display = "block";

      acceptCallBtn.onclick = async () => {
        incomingModal.style.display = "none";

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        peerConnection = new RTCPeerConnection(config);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("callUser", {
              target: remoteSocketId,
              caller: socket.id,
              candidate: e.candidate
            });
          }
        };

        peerConnection.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
        };

        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("answerCall", { to: from, answer });
      };

      declineCallBtn.onclick = () => {
        incomingModal.style.display = "none";
        socket.emit("callEnded", { to: from });
      };
    });

    socket.on("callAccepted", async ({ answer }) => {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on("callUser", async ({ candidate }) => {
      if (candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      }
    });

    socket.on("callEnded", () => {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;
      alert("Ã‡aÄŸrÄ± sonlandÄ±rÄ±ldÄ±");
    });

    // Remote kullanÄ±cÄ±yÄ± al
    socket.on("newUser", (socketId) => {
      if (socketId !== socket.id) {
        remoteSocketId = socketId;
      }
    });

  </script>
</body>
</html>
